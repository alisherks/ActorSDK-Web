{"version":3,"sources":["../../src/components/Dialog.react.js"],"names":[],"mappings":"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","file":"Dialog.react.js","sourcesContent":["/*\n * Copyright (C) 2015-2016 Actor LLC. <https://actor.im>\n */\n\nimport { debounce, map, isFunction } from 'lodash';\n\nimport React, { Component, PropTypes } from 'react';\nimport { findDOMNode } from 'react-dom';\nimport PeerUtils from '../utils/PeerUtils';\n\nimport DefaultMessages from './dialog/MessagesSection.react';\nimport DefaultTyping from './dialog/TypingSection.react';\nimport DefaultCompose from './dialog/ComposeSection.react';\nimport DialogFooter from './dialog/DialogFooter.react';\nimport DefaultToolbar from './Toolbar.react';\nimport DefaultActivity from './Activity.react';\nimport DefaultCall from './Call.react';\nimport ConnectionState from './common/ConnectionState.react';\n\nimport ActivityStore from '../stores/ActivityStore';\nimport DialogStore from '../stores/DialogStore';\nimport MessageStore from '../stores/MessageStore';\n\nimport DialogActionCreators from '../actions/DialogActionCreators';\n\n// On which scrollTop value start loading older messages\nconst loadMessagesScrollTop = 100;\nconst initialRenderMessagesCount = 20;\nconst renderMessagesStep = 20;\n\nlet renderMessagesCount = initialRenderMessagesCount;\nlet lastScrolledFromBottom = 0;\n\nconst getStateFromStores = () => {\n  const messages = MessageStore.getAll();\n  const overlay = MessageStore.getOverlay();\n  const messagesToRender = (messages.length > renderMessagesCount) ? messages.slice(messages.length - renderMessagesCount) : messages;\n  const overlayToRender = (overlay.length > renderMessagesCount) ? overlay.slice(overlay.length - renderMessagesCount) : overlay;\n\n  return {\n    peer: DialogStore.getCurrentPeer(),\n    messages,\n    overlay,\n    messagesToRender,\n    overlayToRender,\n    isMember: DialogStore.isMember()\n  };\n};\n\nclass DialogSection extends Component {\n  static contextTypes = {\n    delegate: PropTypes.object\n  };\n\n  static propTypes = {\n    params: PropTypes.object\n  };\n\n  constructor(props) {\n    super(props);\n\n    this.state = getStateFromStores();\n\n    ActivityStore.addListener(this.fixScrollTimeout);\n    MessageStore.addListener(this.onMessagesChange);\n    DialogStore.addListener(this.onChange);\n  }\n\n  componentWillMount() {\n    const peer = PeerUtils.stringToPeer(this.props.params.id);\n    DialogActionCreators.selectDialogPeer(peer);\n  }\n\n  componentDidMount() {\n    const peer = PeerUtils.stringToPeer(this.props.params.id);\n    if (peer) {\n      this.fixScroll();\n      this.loadMessagesByScroll();\n    }\n  }\n\n  componentWillReceiveProps(nextProps) {\n    const { params } = nextProps;\n    if (this.props.params.id !== params.id) {\n      const peer = PeerUtils.stringToPeer(params.id);\n      DialogActionCreators.selectDialogPeer(peer);\n      if (peer) {\n        this.fixScroll();\n        this.loadMessagesByScroll();\n      }\n    }\n  }\n\n  componentDidUpdate() {\n    this.fixScroll();\n  }\n\n  componentWillUnmount() {\n    DialogActionCreators.selectDialogPeer(null);\n  }\n\n  fixScrollTimeout = () => {\n    setTimeout(this.fixScroll, 50);\n  };\n\n  getScrollArea() {\n    const scrollNode = findDOMNode(this.refs.messagesSection.refs.messagesScroll.refs.scroll);\n    return scrollNode.getElementsByClassName('ss-scrollarea')[0];\n  }\n\n  fixScroll = () => {\n    const node = this.getScrollArea();\n    if (node) {\n      node.scrollTop = node.scrollHeight - lastScrolledFromBottom - node.offsetHeight;\n    }\n  };\n\n  onChange = () => {\n    const nextState = getStateFromStores();\n    if (nextState.peer !== this.state.peer || nextState.messages.length !== this.state.messages.length) {\n      lastScrolledFromBottom = 0;\n      renderMessagesCount = initialRenderMessagesCount;\n    }\n\n    this.setState(nextState);\n  };\n\n  onMessagesChange = debounce(() => {\n    this.setState(getStateFromStores());\n  }, 10, {maxWait: 50, leading: true});\n\n  loadMessagesByScroll = debounce(() => {\n    const { peer, messages, messagesToRender } = this.state;\n\n    if (peer) {\n      const node = this.getScrollArea();\n      let scrollTop = node.scrollTop;\n      lastScrolledFromBottom = node.scrollHeight - scrollTop - node.offsetHeight; // was node.scrollHeight - scrollTop\n\n      if (node.scrollTop < loadMessagesScrollTop) {\n\n        if (messages.length > messagesToRender.length) {\n          renderMessagesCount += renderMessagesStep;\n\n          if (renderMessagesCount > messages.length) {\n            renderMessagesCount = messages.length;\n          }\n\n          this.setState(getStateFromStores());\n        } else {\n            DialogActionCreators.onChatEnd(peer);\n        }\n      }\n    }\n  }, 5, {maxWait: 30});\n\n  getComponents() {\n    const {dialog} = this.context.delegate.components;\n    if (dialog && !isFunction(dialog)) {\n      const activity = dialog.activity || [\n        DefaultActivity,\n        DefaultCall\n      ];\n\n      return {\n        ToolbarSection: dialog.toolbar || DefaultToolbar,\n        MessagesSection: isFunction(dialog.messages) ? dialog.messages : DefaultMessages,\n        TypingSection: dialog.typing || DefaultTyping,\n        ComposeSection: dialog.compose || DefaultCompose,\n        activity: map(activity, (Activity, index) => <Activity key={index} />)\n      };\n    }\n\n    return {\n      ToolbarSection: DefaultToolbar,\n      MessagesSection: DefaultMessages,\n      TypingSection: DefaultTyping,\n      ComposeSection: DefaultCompose,\n      activity: [\n        <DefaultActivity key={1} />,\n        <DefaultCall key={2} />\n      ]\n    };\n  }\n\n  render() {\n    const { peer, isMember, messagesToRender, overlayToRender } = this.state;\n\n    const {\n      ToolbarSection,\n      MessagesSection,\n      TypingSection,\n      ComposeSection,\n      activity\n    } = this.getComponents();\n\n    return (\n      <section className=\"main\">\n        <ToolbarSection />\n        <div className=\"flexrow\">\n          <section className=\"dialog\">\n            <ConnectionState/>\n            <div className=\"messages\">\n              <MessagesSection\n                isMember={isMember}\n                messages={messagesToRender}\n                overlay={overlayToRender}\n                peer={peer}\n                ref=\"messagesSection\"\n                onScroll={this.loadMessagesByScroll}\n              />\n            </div>\n            <DialogFooter isMember={isMember} components={{TypingSection, ComposeSection}} />\n          </section>\n          {activity}\n        </div>\n      </section>\n    );\n  }\n}\n\nexport default DialogSection;\n"]}